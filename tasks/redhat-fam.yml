---

  - name: Pull script configuring official Dell yum repos
    # shell: wget -q -O - http://linux.dell.com/repo/hardware/dsu/bootstrap.cgi | bash
    get_url:
      url: http://linux.dell.com/repo/hardware/dsu/bootstrap.cgi
      dest: /tmp/bootstrap.cgi
      mode: '0700'

  - name: Just import these GPG keys okay
    ansible.builtin.lineinfile:
      path: /tmp/bootstrap.cgi
      regexp: '^IMPORT_GPG_CONFIRMATION="na"'
      line: IMPORT_GPG_CONFIRMATION="y"

  - name: Excute script configuring official Dell yum repos
    shell: /tmp/bootstrap.cgi

  - name: Clean Dell script
    file:
      state: absent
      path: /tmp/bootstrap.cgi

  - name: install DSU
    yum: name=dell-system-update state=present

  - name: Install OMSA
    yum: name={{ meta_pkg_install }} state=present
    notify:
    - start omsa

  - name: Open firewall port (firewalld)
    firewalld:
      port: 1311/tcp
      permanent: true
      immediate: true
      state: enabled
    when: ansible_distribution_major_version == "7"

  # There's probably a more elegant way to do this with the 'iptables' module
  - name: Open firewall port (iptables)
    shell: /sbin/iptables -t filter -I INPUT -m state --state NEW -m tcp
           -p tcp --dport 1311 -j ACCEPT
  # shell: /sbin/iptables-save > /etc/sysconfig/iptables
    when: ansible_distribution_major_version == "6"
